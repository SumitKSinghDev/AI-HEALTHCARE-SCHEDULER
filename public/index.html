<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Healthcare Scheduler - India | ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§™‡•â‡§á‡§Ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .appointments-list {
            grid-column: 1 / -1;
        }

        .appointment-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .appointment-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .appointment-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .patient-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #667eea;
        }

        .appointment-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .ai-analysis {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .ai-analysis h4 {
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .voice-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .voice-btn:hover {
            background: #218838;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 20px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .doctors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .doctor-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .doctor-card:hover {
            background: #e9ecef;
            transform: translateY(-3px);
        }

        .doctor-available {
            border-left: 4px solid #28a745;
        }

        .doctor-busy {
            border-left: 4px solid #dc3545;
            opacity: 0.7;
        }

        .rating {
            color: #ffc107;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-heartbeat"></i> AI Healthcare Scheduler - India</h1>
            <h2 style="font-size: 1.2em; margin: 5px 0; color: #ffd700;">üáÆüá≥ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§™‡•â‡§á‡§Ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ</h2>
            <p>Intelligent appointment booking with AI symptom analysis ‚Ä¢ Indian hospitals ‚Ä¢ Multi-language support</p>
            <div style="margin-top: 10px; font-size: 0.9em; color: #e8f4f8;">
                <span>üè• Apollo ‚Ä¢ Fortis ‚Ä¢ Max ‚Ä¢ Manipal ‚Ä¢ Narayana Health</span>
                <span style="margin-left: 20px;">üí∞ Indian Rupees (‚Çπ)</span>
                <span style="margin-left: 20px;">üó£Ô∏è 10+ Indian Languages</span>
            </div>
            
            <!-- Advanced Features Toggle -->
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="toggleLowBandwidth()" id="bandwidthBtn" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                        <i class="fas fa-signal"></i> Normal Mode
                    </button>
                    <button onclick="show2FA()" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                        <i class="fas fa-shield-alt"></i> 2FA Security
                    </button>
                    <button onclick="showEncryption()" style="background: #6f42c1; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                        <i class="fas fa-lock"></i> Encryption
                    </button>
                    <button onclick="testSmartHome()" style="background: #fd7e14; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                        <i class="fas fa-home"></i> Smart Home
                    </button>
                    <button onclick="checkRewards()" style="background: #e83e8c; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                        <i class="fas fa-gift"></i> Rewards
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Enhanced Appointment Booking Form -->
            <div class="card">
                <h2><i class="fas fa-robot"></i> AI-Powered Appointment Booking</h2>
                
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="patientName">Patient Name</label>
                        <input type="text" id="patientName" name="patientName" required placeholder="Enter patient name">
                    </div>

                    <div class="form-group">
                        <label for="patientMobile">Mobile Number / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</label>
                        <input type="tel" id="patientMobile" name="patientMobile" required 
                               placeholder="+91-9876543210" pattern="[+][0-9]{2}-[0-9]{10}">
                        <small style="color: #666;">Required for appointment reminders (SMS/WhatsApp)</small>
                    </div>

                    <div class="form-group">
                        <label for="patientEmail">Email Address (Optional)</label>
                        <input type="email" id="patientEmail" name="patientEmail" 
                               placeholder="patient@example.com">
                        <small style="color: #666;">For email reminders and confirmations</small>
                    </div>

                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" min="1" max="120" placeholder="Enter age">
                    </div>

                    <div class="form-group">
                        <label for="preferredLanguage">Preferred Language / ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§≠‡§æ‡§∑‡§æ</label>
                        <select id="preferredLanguage" name="preferredLanguage">
                            <option value="English">English / ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä</option>
                            <option value="Hindi">Hindi / ‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                            <option value="Marathi">Marathi / ‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                            <option value="Gujarati">Gujarati / ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
                            <option value="Tamil">Tamil / ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                            <option value="Telugu">Telugu / ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                            <option value="Kannada">Kannada / ‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                            <option value="Malayalam">Malayalam / ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                            <option value="Bengali">Bengali / ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                            <option value="Punjabi">Punjabi / ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="symptoms">Describe Your Symptoms</label>
                        <textarea id="symptoms" name="symptoms" rows="4" placeholder="Describe your symptoms in detail for AI analysis..." required></textarea>
                        <button type="button" class="btn" id="analyzeBtn" style="margin-top: 10px; background: #28a745;">
                            <i class="fas fa-brain"></i> Get AI Analysis First
                        </button>
                    </div>

                    <div id="aiAnalysisResult" style="display: none;" class="ai-analysis">
                        <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                        <div id="analysisContent"></div>
                    </div>

                    <div class="form-group">
                        <label for="preferredDate">Preferred Date</label>
                        <input type="date" id="preferredDate" name="preferredDate" required>
                    </div>

                    <div class="form-group">
                        <label for="preferredTime">Preferred Time</label>
                        <input type="time" id="preferredTime" name="preferredTime" required>
                        <button type="button" class="btn" id="suggestSlotsBtn" style="margin-top: 10px; background: #17a2b8;">
                            <i class="fas fa-magic"></i> Get Smart Slot Suggestions
                        </button>
                    </div>

                    <div id="slotSuggestions" style="display: none;">
                        <h4><i class="fas fa-clock"></i> AI Recommended Time Slots</h4>
                        <div id="suggestedSlots"></div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isRecurring" name="isRecurring"> 
                            Recurring Appointment
                        </label>
                    </div>

                    <div id="recurringOptions" style="display: none;">
                        <div class="form-group">
                            <label for="recurringFreq">Frequency</label>
                            <select id="recurringFreq" name="recurringFreq">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="recurringCount">Number of Appointments</label>
                            <input type="number" id="recurringCount" name="recurringCount" min="2" max="12" value="4">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isGroupAppointment" name="isGroupAppointment"> 
                            Group/Family Appointment
                        </label>
                    </div>

                    <div id="groupOptions" style="display: none;">
                        <div class="form-group">
                            <label for="groupMembers">Additional Members</label>
                            <textarea id="groupMembers" name="groupMembers" rows="2" placeholder="List additional family members or group participants..."></textarea>
                        </div>
                    </div>

                    <button type="submit" class="btn">
                        <i class="fas fa-robot"></i> Book with Full AI Analysis
                    </button>
                </form>

                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> AI is analyzing symptoms and finding optimal appointments...
                </div>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- Enhanced Doctors & Locations -->
            <div class="card">
                <h2><i class="fas fa-user-md"></i> Smart Doctor Recommendations</h2>
                
                <div class="form-group">
                    <label>Filter by:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="specialtyFilter">
                            <option value="">All Specialties</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Neurology">Neurology</option>
                            <option value="General Medicine">General Medicine</option>
                            <option value="Pediatrics">Pediatrics</option>
                        </select>
                        <select id="languageFilter">
                            <option value="">All Languages</option>
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="Mandarin">Mandarin</option>
                        </select>
                        <button type="button" class="btn" id="getRecommendationsBtn" style="background: #6f42c1;">
                            <i class="fas fa-magic"></i> Get AI Recommendations
                        </button>
                    </div>
                </div>

                <div id="recommendedDoctors" style="display: none;">
                    <h4><i class="fas fa-star"></i> AI Recommended for Your Symptoms</h4>
                    <div id="recommendationsGrid"></div>
                </div>
                
                <div class="doctors-grid" id="doctorsGrid">
                    <!-- Doctors will be loaded here -->
                </div>

                <div style="margin-top: 20px;">
                    <h3><i class="fas fa-map-marker-alt"></i> Available Locations</h3>
                    <div id="locationsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Locations will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Patient Experience Tools -->
        <div class="card">
            <h2><i class="fas fa-mobile-alt"></i> Patient Experience Tools</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button class="voice-btn" onclick="testVoiceBooking()" style="background: #25D366;">
                    <i class="fab fa-whatsapp"></i> Test WhatsApp Booking
                </button>
                <button class="voice-btn" onclick="loadQuestionnaire()" style="background: #17a2b8;">
                    <i class="fas fa-clipboard-list"></i> Pre-Visit Questionnaire
                </button>
                <button class="voice-btn" onclick="digitalCheckIn()" style="background: #6f42c1;">
                    <i class="fas fa-qrcode"></i> Digital Check-In
                </button>
                <button class="voice-btn" onclick="checkWaitTime()" style="background: #fd7e14;">
                    <i class="fas fa-clock"></i> Wait Time Prediction
                </button>
                <button class="voice-btn" onclick="processPayment()" style="background: #28a745;">
                    <i class="fas fa-credit-card"></i> Demo Payment
                </button>
                <button class="voice-btn" onclick="payWithRazorpay()" style="background: #3395FF; margin-left: 10px;">
                    <i class="fas fa-mobile-alt"></i> Pay with Razorpay (Demo)
                </button>
                <button class="voice-btn" onclick="showReminderSelector()" style="background: #dc3545;">
                    <i class="fas fa-bell"></i> Send Reminder
                </button>
                <button class="voice-btn" onclick="showAppointmentManager()" style="background: #17a2b8;">
                    <i class="fas fa-clipboard-check"></i> Complete Appointment
                </button>
                <button class="voice-btn" onclick="generateSlip()" style="background: #6f42c1;">
                    <i class="fas fa-receipt"></i> Generate Slip
                </button>
            </div>

            <div id="patientToolsResults" style="display: none;" class="ai-analysis">
                <h4>Results</h4>
                <div id="toolsResultsContent"></div>
            </div>
        </div>

        <!-- Doctor & Clinic Management Tools -->
        <div class="card">
            <h2><i class="fas fa-user-md"></i> Doctor & Clinic Management</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button class="voice-btn" onclick="optimizeCalendar()" style="background: #6c757d;">
                    <i class="fas fa-calendar-alt"></i> AI Calendar Optimization
                </button>
                <button class="voice-btn" onclick="smartReschedule()" style="background: #e83e8c;">
                    <i class="fas fa-exchange-alt"></i> Smart Rescheduling
                </button>
                <button class="voice-btn" onclick="createTelemedicine()" style="background: #20c997;">
                    <i class="fas fa-video"></i> Telemedicine Setup
                </button>
                <button class="voice-btn" onclick="viewAnalytics()" style="background: #fd7e14;">
                    <i class="fas fa-chart-line"></i> Analytics Dashboard
                </button>
            </div>

            <div id="doctorToolsResults" style="display: none;" class="ai-analysis">
                <h4>Management Results</h4>
                <div id="doctorResultsContent"></div>
            </div>
        </div>

        <!-- Appointments List -->
        <div class="card appointments-list">
            <h2><i class="fas fa-list"></i> Your Appointments</h2>
            <div id="appointmentsList">
                <!-- Appointments will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Set minimum date to today
        document.getElementById('preferredDate').min = new Date().toISOString().split('T')[0];

        // Load doctors, appointments, and locations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDoctors();
            loadAppointments();
            loadLocations();
            setupEventListeners();
        });

        // Setup enhanced event listeners
        function setupEventListeners() {
            // Recurring appointment checkbox
            document.getElementById('isRecurring').addEventListener('change', function() {
                document.getElementById('recurringOptions').style.display = this.checked ? 'block' : 'none';
            });

            // Group appointment checkbox
            document.getElementById('isGroupAppointment').addEventListener('change', function() {
                document.getElementById('groupOptions').style.display = this.checked ? 'block' : 'none';
            });

            // AI Analysis button
            document.getElementById('analyzeBtn').addEventListener('click', analyzeSymptoms);

            // Smart slot suggestions button
            document.getElementById('suggestSlotsBtn').addEventListener('click', getSlotSuggestions);

            // AI recommendations button
            document.getElementById('getRecommendationsBtn').addEventListener('click', getDoctorRecommendations);

            // Filter event listeners
            document.getElementById('specialtyFilter').addEventListener('change', filterDoctors);
            document.getElementById('languageFilter').addEventListener('change', filterDoctors);
        }

        // Enhanced load doctors with advanced info
        async function loadDoctors(filters = {}) {
            try {
                const params = new URLSearchParams(filters);
                const response = await fetch(`/api/doctors?${params}`);
                const data = await response.json();
                
                const doctorsGrid = document.getElementById('doctorsGrid');
                doctorsGrid.innerHTML = '';
                
                data.doctors.forEach(doctor => {
                    const doctorCard = document.createElement('div');
                    doctorCard.className = `doctor-card ${doctor.available ? 'doctor-available' : 'doctor-busy'}`;
                    doctorCard.innerHTML = `
                        <h4>${doctor.name}</h4>
                        <p><strong>${doctor.specialty}</strong></p>
                        <p><i class="fas fa-map-marker-alt"></i> ${doctor.location}</p>
                        <p><i class="fas fa-language"></i> ${doctor.languages.join(', ')}</p>
                        <div class="rating">
                            ${'‚òÖ'.repeat(Math.floor(doctor.rating))} ${doctor.rating}
                        </div>
                        <p><i class="fas fa-user-md"></i> ${doctor.experience} years experience</p>
                        <p><i class="fas fa-circle" style="color: ${doctor.available ? '#28a745' : '#dc3545'}"></i> 
                           ${doctor.available ? 'Available' : 'Busy'}</p>
                        <button class="voice-btn" onclick="checkAvailability('${doctor.id}')">
                            <i class="fas fa-calendar-check"></i> Check Availability
                        </button>
                    `;
                    doctorsGrid.appendChild(doctorCard);
                });
            } catch (error) {
                console.error('Error loading doctors:', error);
            }
        }

        // Load locations
        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                const data = await response.json();
                
                const locationsGrid = document.getElementById('locationsGrid');
                locationsGrid.innerHTML = '';
                
                data.locations.forEach(location => {
                    const locationCard = document.createElement('div');
                    locationCard.className = 'doctor-card';
                    locationCard.innerHTML = `
                        <h4>${location.name}</h4>
                        <p><i class="fas fa-map-marker-alt"></i> ${location.address}</p>
                        <p><strong>Departments:</strong> ${location.departments.join(', ')}</p>
                    `;
                    locationsGrid.appendChild(locationCard);
                });
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // AI Symptom Analysis
        async function analyzeSymptoms() {
            const symptoms = document.getElementById('symptoms').value;
            const patientName = document.getElementById('patientName').value;
            const age = document.getElementById('age').value;

            if (!symptoms) {
                alert('Please describe your symptoms first');
                return;
            }

            try {
                const response = await fetch('/api/analyze-symptoms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symptoms, patientName, age })
                });

                const data = await response.json();
                
                if (data.success) {
                    const analysisResult = document.getElementById('aiAnalysisResult');
                    const analysisContent = document.getElementById('analysisContent');
                    
                    analysisContent.innerHTML = `
                        <p><strong>Specialty Recommended:</strong> ${data.analysis.specialty || 'General Medicine'}</p>
                        <p><strong>Urgency Level:</strong> <span style="color: ${getUrgencyColor(data.analysis.urgency)}">${data.analysis.urgency || 'medium'}</span></p>
                        <p><strong>AI Reasoning:</strong> ${data.analysis.reasoning}</p>
                        <p><strong>Recommended Action:</strong> ${data.analysis.recommended_action}</p>
                    `;
                    
                    analysisResult.style.display = 'block';
                } else {
                    alert('AI analysis failed: ' + data.error);
                }
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Failed to get AI analysis');
            }
        }

        // Smart slot suggestions
        async function getSlotSuggestions() {
            const symptoms = document.getElementById('symptoms').value;
            const patientName = document.getElementById('patientName').value;
            const preferredLanguage = document.getElementById('preferredLanguage').value;

            if (!symptoms || !patientName) {
                alert('Please fill in patient name and symptoms first');
                return;
            }

            try {
                const response = await fetch('/api/suggest-slots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symptoms, patientName, preferredLanguage })
                });

                const data = await response.json();
                
                if (data.success) {
                    const slotSuggestions = document.getElementById('slotSuggestions');
                    const suggestedSlots = document.getElementById('suggestedSlots');
                    
                    suggestedSlots.innerHTML = data.suggestions.map(slot => `
                        <div class="doctor-card" style="cursor: pointer;" onclick="selectSlot('${slot.date}', '${slot.time}', '${slot.doctor}')">
                            <h4>${slot.doctor} (${slot.specialty})</h4>
                            <p><i class="fas fa-calendar"></i> ${slot.date} at ${slot.time}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${slot.location}</p>
                            <p><strong>Score:</strong> ${slot.score}/100</p>
                            <p><strong>Why recommended:</strong> ${slot.reasoning}</p>
                            <button class="voice-btn">
                                <i class="fas fa-check"></i> Select This Slot
                            </button>
                        </div>
                    `).join('');
                    
                    slotSuggestions.style.display = 'block';
                } else {
                    alert('Failed to get slot suggestions: ' + data.error);
                }
            } catch (error) {
                console.error('Slot suggestion error:', error);
                alert('Failed to get smart suggestions');
            }
        }

        // Doctor recommendations
        async function getDoctorRecommendations() {
            const symptoms = document.getElementById('symptoms').value;
            const patientName = document.getElementById('patientName').value;
            const preferredLanguage = document.getElementById('preferredLanguage').value;

            if (!symptoms) {
                alert('Please describe your symptoms first');
                return;
            }

            try {
                const response = await fetch('/api/recommend-doctors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symptoms, patientName, preferredLanguage })
                });

                const data = await response.json();
                
                if (data.success) {
                    const recommendedDoctors = document.getElementById('recommendedDoctors');
                    const recommendationsGrid = document.getElementById('recommendationsGrid');
                    
                    recommendationsGrid.innerHTML = data.recommendations.map(doctor => `
                        <div class="doctor-card doctor-available" style="border: 2px solid #28a745;">
                            <h4>‚≠ê ${doctor.name}</h4>
                            <p><strong>${doctor.specialty}</strong></p>
                            <p><i class="fas fa-map-marker-alt"></i> ${doctor.location}</p>
                            <p><i class="fas fa-language"></i> ${doctor.languages.join(', ')}</p>
                            <div class="rating">
                                ${'‚òÖ'.repeat(Math.floor(doctor.rating))} ${doctor.rating}
                            </div>
                            <p><strong>Match Score:</strong> ${doctor.matchScore}/100</p>
                            <p><i class="fas fa-user-md"></i> ${doctor.experience} years experience</p>
                        </div>
                    `).join('');
                    
                    recommendedDoctors.style.display = 'block';
                } else {
                    alert('Failed to get recommendations: ' + data.error);
                }
            } catch (error) {
                console.error('Recommendation error:', error);
                alert('Failed to get AI recommendations');
            }
        }

        // Helper functions
        function getUrgencyColor(urgency) {
            const colors = {
                emergency: '#dc3545',
                high: '#fd7e14',
                medium: '#ffc107',
                low: '#28a745'
            };
            return colors[urgency] || '#6c757d';
        }

        function selectSlot(date, time, doctor) {
            document.getElementById('preferredDate').value = date;
            document.getElementById('preferredTime').value = time;
            alert(`Selected: ${doctor} on ${date} at ${time}`);
        }

        function filterDoctors() {
            const specialty = document.getElementById('specialtyFilter').value;
            const language = document.getElementById('languageFilter').value;
            
            const filters = {};
            if (specialty) filters.specialty = specialty;
            if (language) filters.language = language;
            
            loadDoctors(filters);
        }

        async function checkAvailability(doctorId) {
            const date = document.getElementById('preferredDate').value;
            if (!date) {
                alert('Please select a date first');
                return;
            }

            try {
                const response = await fetch(`/api/availability/${doctorId}/${date}`);
                const data = await response.json();
                
                if (data.success) {
                    const slots = data.availableSlots.join(', ') || 'No slots available';
                    alert(`${data.doctor} availability on ${date}:\n\nAvailable slots: ${slots}\n\nTotal slots: ${data.totalSlots}\nBooked: ${data.bookedSlots}`);
                } else {
                    alert('Failed to check availability: ' + data.error);
                }
            } catch (error) {
                console.error('Availability error:', error);
                alert('Failed to check availability');
            }
        }

        // Load appointments
        async function loadAppointments() {
            try {
                const response = await fetch('/api/appointments');
                const data = await response.json();
                
                const appointmentsList = document.getElementById('appointmentsList');
                appointmentsList.innerHTML = '';
                
                data.appointments.forEach(appointment => {
                    const appointmentItem = document.createElement('div');
                    appointmentItem.className = 'appointment-item';
                    appointmentItem.innerHTML = `
                        <div class="appointment-header">
                            <span class="patient-name">${appointment.patient}</span>
                            <span class="appointment-status status-${appointment.status}">${appointment.status.toUpperCase()}</span>
                        </div>
                        <p><i class="fas fa-user-md"></i> <strong>Doctor:</strong> ${appointment.doctor}</p>
                        <p><i class="fas fa-calendar"></i> <strong>Date:</strong> ${appointment.date} at ${appointment.time}</p>
                        <p><i class="fas fa-stethoscope"></i> <strong>Symptoms:</strong> ${appointment.symptoms}</p>
                        ${appointment.analysis ? `
                            <div class="ai-analysis">
                                <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                                <p>${appointment.analysis}</p>
                                <div class="voice-controls">
                                    <button class="voice-btn" onclick="playConfirmation('${appointment.id}')">
                                        <i class="fas fa-volume-up"></i> Play Confirmation
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    `;
                    appointmentsList.appendChild(appointmentItem);
                });
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // Enhanced appointment form submission
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loading');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Hide previous messages
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            loading.style.display = 'block';
            submitBtn.disabled = true;
            
            // Collect enhanced form data
            const appointmentData = {
                patient: document.getElementById('patientName').value,
                mobile: document.getElementById('patientMobile').value,
                email: document.getElementById('patientEmail').value,
                symptoms: document.getElementById('symptoms').value,
                preferredDate: document.getElementById('preferredDate').value,
                preferredTime: document.getElementById('preferredTime').value,
                preferredLanguage: document.getElementById('preferredLanguage').value,
                age: document.getElementById('age').value,
                isRecurring: document.getElementById('isRecurring').checked,
                isGroupAppointment: document.getElementById('isGroupAppointment').checked
            };

            // Add recurring pattern if selected
            if (appointmentData.isRecurring) {
                appointmentData.recurringPattern = {
                    frequency: document.getElementById('recurringFreq').value,
                    count: parseInt(document.getElementById('recurringCount').value)
                };
            }

            // Add group members if selected
            if (appointmentData.isGroupAppointment) {
                appointmentData.groupMembers = document.getElementById('groupMembers').value.split(',').map(m => m.trim());
            }
            
            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successMessage.innerHTML = `
                        <h4><i class="fas fa-check-circle"></i> Advanced AI Booking Successful!</h4>
                        <p>${data.message}</p>
                        
                        <div class="ai-analysis">
                            <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                            <p><strong>Specialty:</strong> ${data.analysis.specialty}</p>
                            <p><strong>Urgency:</strong> <span style="color: ${getUrgencyColor(data.analysis.urgency)}">${data.analysis.urgency}</span></p>
                            <p><strong>Reasoning:</strong> ${data.analysis.reasoning}</p>
                        </div>

                        <div class="ai-analysis">
                            <h4><i class="fas fa-user-md"></i> Doctor Recommendation</h4>
                            <p><strong>Selected:</strong> ${data.doctorRecommendation.doctor.name}</p>
                            <p><strong>Specialty:</strong> ${data.doctorRecommendation.doctor.specialty}</p>
                            <p><strong>Location:</strong> ${data.doctorRecommendation.doctor.location}</p>
                            <p><strong>Why selected:</strong> ${data.doctorRecommendation.reasoning}</p>
                        </div>

                        ${data.noShowPrediction.risk !== 'low' ? `
                        <div class="ai-analysis" style="background: #fff3cd;">
                            <h4><i class="fas fa-exclamation-triangle"></i> No-Show Risk Prediction</h4>
                            <p><strong>Risk Level:</strong> ${data.noShowPrediction.risk}</p>
                            <p><strong>Factors:</strong> ${data.noShowPrediction.factors.join(', ')}</p>
                            <p><em>We'll send extra reminders for this appointment.</em></p>
                        </div>
                        ` : ''}

                        ${data.slotSuggestions.length > 0 ? `
                        <div class="ai-analysis">
                            <h4><i class="fas fa-clock"></i> Alternative AI Suggestions</h4>
                            ${data.slotSuggestions.map(slot => `
                                <p>‚Ä¢ ${slot.doctor} on ${slot.date} at ${slot.time} (Score: ${slot.score}/100)</p>
                            `).join('')}
                        </div>
                        ` : ''}

                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playVoiceConfirmation('${data.confirmationText}')">
                                <i class="fas fa-volume-up"></i> Play Voice Confirmation
                            </button>
                            ${appointmentData.isRecurring ? `
                            <button class="voice-btn" style="background: #6f42c1;">
                                <i class="fas fa-repeat"></i> ${appointmentData.recurringPattern.count} Appointments Scheduled
                            </button>
                            ` : ''}
                        </div>
                    `;
                    successMessage.style.display = 'block';
                    e.target.reset();
                    document.getElementById('recurringOptions').style.display = 'none';
                    document.getElementById('groupOptions').style.display = 'none';
                    loadAppointments(); // Refresh appointments list
                } else {
                    throw new Error(data.error);
                }
                
            } catch (error) {
                errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Play voice confirmation
        async function playVoiceConfirmation(text) {
            try {
                const response = await fetch('/api/voice/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });
                
                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    alert('Voice generation temporarily unavailable');
                }
            } catch (error) {
                console.error('Voice error:', error);
                alert('Voice generation temporarily unavailable');
            }
        }

        // Play confirmation for existing appointments
        function playConfirmation(appointmentId) {
            const text = `Your appointment has been confirmed. Please arrive 15 minutes early for your scheduled visit.`;
            playVoiceConfirmation(text);
        }

        // === PATIENT EXPERIENCE TOOLS ===

        async function testVoiceBooking() {
            try {
                const response = await fetch('/api/voice/book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'I need to book an appointment for headache tomorrow at 2 PM',
                        platform: 'whatsapp',
                        phoneNumber: '+1234567890'
                    })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5><i class="fab fa-whatsapp"></i> WhatsApp Booking Test</h5>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                    <p><strong>Response:</strong> ${data.response}</p>
                    ${data.appointment ? `<p><strong>Appointment:</strong> ${data.appointment.doctor} on ${data.appointment.date}</p>` : ''}
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Voice booking test failed: ${error.message}</p>`);
            }
        }

        async function loadQuestionnaire() {
            try {
                const response = await fetch('/api/questionnaire/general');
                const data = await response.json();
                
                if (data.success) {
                    const questionsHtml = data.questions.map((q, i) => `
                        <div style="margin: 10px 0;">
                            <label>${i + 1}. ${q}</label>
                            <input type="text" id="q${i}" placeholder="Your answer..." style="width: 100%; margin-top: 5px;">
                        </div>
                    `).join('');

                    showPatientToolResult(`
                        <h5><i class="fas fa-clipboard-list"></i> Pre-Visit Questionnaire</h5>
                        <p><strong>Specialty:</strong> ${data.specialty}</p>
                        <p><strong>Estimated Time:</strong> ${data.estimatedTime}</p>
                        ${questionsHtml}
                        <button class="voice-btn" onclick="submitQuestionnaire('${data.specialty}')" style="margin-top: 15px;">
                            <i class="fas fa-paper-plane"></i> Submit Questionnaire
                        </button>
                    `);
                }
            } catch (error) {
                showPatientToolResult(`<p class="error">Failed to load questionnaire: ${error.message}</p>`);
            }
        }

        async function submitQuestionnaire(specialty) {
            const answers = [];
            for (let i = 0; i < 6; i++) {
                const answer = document.getElementById(`q${i}`)?.value || 'Not provided';
                answers.push(answer);
            }

            try {
                const response = await fetch('/api/questionnaire/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patientName: document.getElementById('patientName').value || 'Demo Patient',
                        specialty,
                        answers
                    })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5>‚úÖ Questionnaire Submitted</h5>
                    <p>${data.message}</p>
                    <p><strong>Next Steps:</strong> ${data.nextSteps}</p>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Submission failed: ${error.message}</p>`);
            }
        }

        async function digitalCheckIn() {
            try {
                // First, get current appointments to find a valid ID
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                // Use first available appointment or default to '1' 
                const appointmentId = appointmentsData.appointments && appointmentsData.appointments.length > 0 
                    ? appointmentsData.appointments[0].id 
                    : '1';
                
                const response = await fetch(`/api/checkin/${appointmentId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qrCode: 'QR123456' })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5><i class="fas fa-qrcode"></i> Digital Check-In</h5>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Checked In' : '‚ùå Failed'}</p>
                    <p><strong>Message:</strong> ${data.message}</p>
                    <p><strong>Appointment ID:</strong> ${appointmentId}</p>
                    ${data.queuePosition ? `<p><strong>Queue Position:</strong> #${data.queuePosition}</p>` : ''}
                    ${data.estimatedWaitTime ? `<p><strong>Estimated Wait:</strong> ${data.estimatedWaitTime} minutes</p>` : ''}
                    ${data.instructions ? `<p><strong>Instructions:</strong> ${data.instructions}</p>` : ''}
                    ${!data.success ? `<p><strong>Error:</strong> ${data.error}</p>` : ''}
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Check-in failed: ${error.message}</p>`);
            }
        }

        async function checkWaitTime() {
            const location = 'Apollo Hospital - Cardiology Department';
            
            try {
                const response = await fetch(`/api/waittime/${encodeURIComponent(location)}`);
                const data = await response.json();
                
                if (data.success) {
                    showPatientToolResult(`
                        <h5><i class="fas fa-clock"></i> Wait Time Prediction</h5>
                        <p><strong>Location:</strong> ${data.location}</p>
                        <p><strong>Current Delay:</strong> ${data.currentDelay} minutes</p>
                        <p><strong>Estimated Wait:</strong> ${data.estimatedWaitTime} minutes</p>
                        <p><strong>Patients Ahead:</strong> ${data.patientsAhead}</p>
                        <p><strong>Avg Consult Time:</strong> ${data.averageConsultTime} minutes</p>
                        <p><strong>Last Updated:</strong> ${new Date(data.lastUpdated).toLocaleTimeString()}</p>
                    `);
                } else {
                    showPatientToolResult(`<p class="error">${data.error}</p>`);
                }
            } catch (error) {
                showPatientToolResult(`<p class="error">Wait time check failed: ${error.message}</p>`);
            }
        }

        async function processPayment() {
            try {
                // Get current appointments to find a valid ID
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                const appointmentId = appointmentsData.appointments && appointmentsData.appointments.length > 0 
                    ? appointmentsData.appointments[0].id 
                    : '1';
                
                const response = await fetch('/api/payment/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appointmentId,
                        amount: 1500,
                        paymentMethod: 'upi',
                        insuranceInfo: { provider: 'Star Health Insurance', verified: true }
                    })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5><i class="fas fa-credit-card"></i> Online Payment - Indian Gateway</h5>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Payment Successful' : '‚ùå Payment Failed'}</p>
                    <p><strong>Appointment ID:</strong> ${appointmentId}</p>
                    <p><strong>Transaction ID:</strong> ${data.payment?.transactionId}</p>
                    <p><strong>Amount:</strong> ‚Çπ${data.payment?.amount} ${data.payment?.currency || 'INR'}</p>
                    <p><strong>Payment Gateway:</strong> ${data.payment?.gateway || 'UPI'}</p>
                    <p><strong>Method:</strong> ${data.payment?.paymentMethod}</p>
                    <p><strong>Insurance:</strong> ${data.insuranceStatus}</p>
                    <p><strong>Supported Methods:</strong> ${data.supportedMethods ? data.supportedMethods.join(', ') : 'UPI, Cards, Net Banking'}</p>
                    <p><strong>Processed:</strong> ${new Date(data.payment?.processedAt).toLocaleString('en-IN')}</p>
                    ${!data.success ? `<p><strong>Error:</strong> ${data.error}</p>` : ''}
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Payment processing failed: ${error.message}</p>`);
            }
        }

        // Show patient selector for reminders
        async function showReminderSelector() {
            try {
                // Get all appointments to show patient options
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                if (!appointmentsData.appointments || appointmentsData.appointments.length === 0) {
                    showPatientToolResult(`
                        <h5><i class="fas fa-bell"></i> Send Reminder</h5>
                        <p><strong>‚ùå No appointments found</strong></p>
                        <p>Please book an appointment first to send reminders.</p>
                    `);
                    return;
                }

                const appointmentOptions = appointmentsData.appointments.map(apt => `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; transition: background 0.3s;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'"
                         onclick="selectPatientForReminder('${apt.id}', '${apt.patient}', '${apt.doctor}', '${apt.date}', '${apt.time}', '${apt.mobile || 'N/A'}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h6 style="margin: 0; color: #007bff;">${apt.patient}</h6>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Doctor:</strong> ${apt.doctor}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Date:</strong> ${apt.date} at ${apt.time}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Mobile:</strong> ${apt.mobile || 'Not provided'}</p>
                            </div>
                            <div>
                                <span style="background: ${apt.status === 'confirmed' ? '#28a745' : '#ffc107'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em;">
                                    ${apt.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');

                showPatientToolResult(`
                    <h5><i class="fas fa-bell"></i> Select Patient for Reminder</h5>
                    <p><strong>Choose a patient to send appointment reminder:</strong></p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${appointmentOptions}
                    </div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 15px;">
                        <strong>üí° Tip:</strong> Click on any patient above to send them a reminder
                    </div>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Failed to load patients: ${error.message}</p>`);
            }
        }

        // Send reminder to selected patient
        async function selectPatientForReminder(appointmentId, patientName, doctorName, date, time, mobile) {
            try {
                // Show reminder type selection
                const reminderTypes = [
                    { type: 'sms', name: 'SMS', icon: 'üì±', description: 'Text message to mobile' },
                    { type: 'whatsapp', name: 'WhatsApp', icon: 'üí¨', description: 'WhatsApp message' },
                    { type: 'email', name: 'Email', icon: 'üìß', description: 'Email notification' }
                ];

                const reminderOptions = reminderTypes.map(rt => `
                    <button onclick="sendReminderToPatient('${appointmentId}', '${patientName}', '${rt.type}')" 
                            style="display: block; width: 100%; margin: 10px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#007bff'"
                            onmouseout="this.style.background='white'; this.style.borderColor='#ddd'">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 2em;">${rt.icon}</span>
                            <div>
                                <h6 style="margin: 0; color: #007bff;">${rt.name}</h6>
                                <p style="margin: 5px 0; font-size: 0.9em; color: #666;">${rt.description}</p>
                            </div>
                        </div>
                    </button>
                `).join('');

                showPatientToolResult(`
                    <h5><i class="fas fa-user"></i> Send Reminder to ${patientName}</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h6>üìã Appointment Details:</h6>
                        <p><strong>Patient:</strong> ${patientName}</p>
                        <p><strong>Doctor:</strong> ${doctorName}</p>
                        <p><strong>Date & Time:</strong> ${date} at ${time}</p>
                        <p><strong>Mobile:</strong> ${mobile}</p>
                    </div>
                    
                    <h6>üì± Choose Reminder Method:</h6>
                    ${reminderOptions}
                    
                    <button onclick="showReminderSelector()" 
                            style="margin-top: 15px; padding: 10px 20px; border: 1px solid #6c757d; border-radius: 5px; background: #f8f9fa; cursor: pointer;">
                        <i class="fas fa-arrow-left"></i> Back to Patient List
                    </button>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Failed to show reminder options: ${error.message}</p>`);
            }
        }

        // Send reminder to specific patient with selected method
        async function sendReminderToPatient(appointmentId, patientName, reminderType) {
            try {
                const response = await fetch('/api/reminders/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appointmentId,
                        type: reminderType
                    })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5><i class="fas fa-check-circle"></i> Reminder Sent Successfully!</h5>
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h6>‚úÖ Reminder Details:</h6>
                        <p><strong>Patient:</strong> ${patientName}</p>
                        <p><strong>Delivery Method:</strong> ${data.reminderContent?.deliveryMethod || reminderType.toUpperCase()}</p>
                        <p><strong>Sent To:</strong> ${data.reminderContent?.recipient || 'Contact not available'}</p>
                        <p><strong>Sent At:</strong> ${data.reminderContent?.sentAt ? new Date(data.reminderContent.sentAt).toLocaleString('en-IN') : 'Now'}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h6>üì± Message Content:</h6>
                        <pre style="white-space: pre-wrap; font-size: 0.9em; margin: 10px 0; font-family: inherit;">${data.reminderContent?.content}</pre>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <strong>üìä Reminder Status:</strong> ${data.success ? 'Delivered' : 'Failed'}<br>
                        <small>In production, this would integrate with real SMS/WhatsApp/Email APIs</small>
                    </div>
                    
                    <button onclick="showReminderSelector()" 
                            style="margin-top: 15px; padding: 10px 20px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer;">
                        <i class="fas fa-bell"></i> Send Another Reminder
                    </button>
                    
                    ${!data.success ? `<p style="color: red;"><strong>Error:</strong> ${data.error}</p>` : ''}
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Reminder failed: ${error.message}</p>`);
            }
        }

        // === APPOINTMENT MANAGEMENT ===

        // Show appointment manager for completion
        async function showAppointmentManager() {
            try {
                // Get all appointments
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                const checkedInAppointments = appointmentsData.appointments.filter(apt => 
                    apt.status === 'checked-in' || apt.status === 'confirmed'
                );
                
                if (checkedInAppointments.length === 0) {
                    showPatientToolResult(`
                        <h5><i class="fas fa-clipboard-check"></i> Complete Appointment</h5>
                        <p><strong>‚ùå No appointments ready for completion</strong></p>
                        <p>Patients need to check-in first before completing appointments.</p>
                    `);
                    return;
                }

                const appointmentOptions = checkedInAppointments.map(apt => `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; transition: background 0.3s;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'"
                         onclick="completeAppointmentForm('${apt.id}', '${apt.patient}', '${apt.doctor}', '${apt.date}', '${apt.time}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h6 style="margin: 0; color: #007bff;">${apt.patient}</h6>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Doctor:</strong> ${apt.doctor}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Date:</strong> ${apt.date} at ${apt.time}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Symptoms:</strong> ${apt.symptoms}</p>
                                ${apt.checkinTime ? `<p style="margin: 5px 0; font-size: 0.8em; color: #28a745;"><strong>Checked in:</strong> ${new Date(apt.checkinTime).toLocaleString('en-IN')}</p>` : ''}
                            </div>
                            <div>
                                <span style="background: ${apt.status === 'checked-in' ? '#28a745' : '#ffc107'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em;">
                                    ${apt.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');

                showPatientToolResult(`
                    <h5><i class="fas fa-clipboard-check"></i> Complete Appointment</h5>
                    <p><strong>Select appointment to complete:</strong></p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${appointmentOptions}
                    </div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 15px;">
                        <strong>üí° Tip:</strong> Click on any appointment to add diagnosis and complete
                    </div>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Failed to load appointments: ${error.message}</p>`);
            }
        }

        // Show completion form for selected appointment
        async function completeAppointmentForm(appointmentId, patientName, doctorName, date, time) {
            showPatientToolResult(`
                <h5><i class="fas fa-user-md"></i> Complete Appointment - ${patientName}</h5>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h6>üìã Appointment Details:</h6>
                    <p><strong>Patient:</strong> ${patientName}</p>
                    <p><strong>Doctor:</strong> ${doctorName}</p>
                    <p><strong>Date & Time:</strong> ${date} at ${time}</p>
                </div>
                
                <form onsubmit="submitAppointmentCompletion(event, '${appointmentId}', '${patientName}')" style="margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ü©∫ Diagnosis:</label>
                        <textarea id="diagnosis" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                  placeholder="Enter diagnosis..." required></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">üíä Prescription:</label>
                        <textarea id="prescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                  placeholder="Enter prescription and medications..."></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìÖ Follow-up Date (Optional):</label>
                        <input type="date" id="followUpDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">üìù Doctor Notes:</label>
                        <textarea id="doctorNotes" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" 
                                  placeholder="Additional notes..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" style="flex: 1; padding: 12px; border: none; border-radius: 5px; background: #28a745; color: white; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-check"></i> Complete Appointment
                        </button>
                        <button type="button" onclick="showAppointmentManager()" style="flex: 0.3; padding: 12px; border: 1px solid #6c757d; border-radius: 5px; background: #f8f9fa; cursor: pointer;">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>
                </form>
            `);
        }

        // Submit appointment completion
        async function submitAppointmentCompletion(event, appointmentId, patientName) {
            event.preventDefault();
            
            try {
                const diagnosis = document.getElementById('diagnosis').value;
                const prescription = document.getElementById('prescription').value;
                const followUpDate = document.getElementById('followUpDate').value;
                const notes = document.getElementById('doctorNotes').value;
                
                const response = await fetch(`/api/appointments/${appointmentId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        diagnosis,
                        prescription,
                        followUpDate,
                        notes
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showPatientToolResult(`
                        <h5><i class="fas fa-check-circle"></i> Appointment Completed Successfully!</h5>
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h6>‚úÖ Completion Details:</h6>
                            <p><strong>Patient:</strong> ${patientName}</p>
                            <p><strong>Status:</strong> Completed</p>
                            <p><strong>Completed At:</strong> ${new Date(data.appointment.completedTime).toLocaleString('en-IN')}</p>
                            <p><strong>Reward Points Earned:</strong> +100 points üèÜ</p>
                            <p><strong>Total Points:</strong> ${data.rewardPoints}</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h6>üìã Medical Summary:</h6>
                            <p><strong>Diagnosis:</strong> ${diagnosis}</p>
                            ${prescription ? `<p><strong>Prescription:</strong> ${prescription}</p>` : ''}
                            ${followUpDate ? `<p><strong>Follow-up:</strong> ${followUpDate}</p>` : ''}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="generateSlipForAppointment('${appointmentId}')" style="flex: 1; padding: 12px; border: none; border-radius: 5px; background: #6f42c1; color: white; cursor: pointer;">
                                <i class="fas fa-receipt"></i> Generate Slip
                            </button>
                            <button onclick="showAppointmentManager()" style="flex: 0.5; padding: 12px; border: 1px solid #007bff; border-radius: 5px; background: white; color: #007bff; cursor: pointer;">
                                <i class="fas fa-plus"></i> Complete Another
                            </button>
                        </div>
                    `);
                } else {
                    showPatientToolResult(`<p class="error">Failed to complete appointment: ${data.error}</p>`);
                }
            } catch (error) {
                showPatientToolResult(`<p class="error">Completion failed: ${error.message}</p>`);
            }
        }

        // Generate slip for any appointment
        async function generateSlip() {
            try {
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                if (!appointmentsData.appointments || appointmentsData.appointments.length === 0) {
                    showPatientToolResult(`
                        <h5><i class="fas fa-receipt"></i> Generate Slip</h5>
                        <p><strong>‚ùå No appointments found</strong></p>
                        <p>Please book an appointment first to generate slips.</p>
                    `);
                    return;
                }

                const appointmentOptions = appointmentsData.appointments.map(apt => `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; transition: background 0.3s;" 
                         onmouseover="this.style.background='#f8f9fa'" 
                         onmouseout="this.style.background='white'"
                         onclick="generateSlipForAppointment('${apt.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h6 style="margin: 0; color: #007bff;">${apt.patient}</h6>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Doctor:</strong> ${apt.doctor}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Date:</strong> ${apt.date} at ${apt.time}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Location:</strong> ${apt.location}</p>
                            </div>
                            <div>
                                <span style="background: ${getStatusColor(apt.status)}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8em;">
                                    ${apt.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');

                showPatientToolResult(`
                    <h5><i class="fas fa-receipt"></i> Generate Appointment Slip</h5>
                    <p><strong>Select appointment to generate slip:</strong></p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${appointmentOptions}
                    </div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 15px;">
                        <strong>üí° Tip:</strong> Click on any appointment to generate detailed slip
                    </div>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Failed to load appointments: ${error.message}</p>`);
            }
        }

        // Generate slip for specific appointment
        async function generateSlipForAppointment(appointmentId) {
            try {
                const response = await fetch(`/api/appointments/${appointmentId}/slip`);
                const data = await response.json();
                
                if (data.success) {
                    const slip = data.slip;
                    showPatientToolResult(`
                        <div style="background: white; border: 2px solid #007bff; border-radius: 10px; padding: 20px; margin: 15px 0; font-family: monospace;">
                            <div style="text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #007bff;">üè• ${slip.hospitalInfo.name}</h4>
                                <p style="margin: 5px 0; font-size: 0.9em;">${slip.hospitalInfo.address}</p>
                                <p style="margin: 5px 0; font-size: 0.9em;"><strong>Department:</strong> ${slip.hospitalInfo.department}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                <div>
                                    <h6 style="color: #007bff; margin-bottom: 10px;">üë§ Patient Information</h6>
                                    <p><strong>Name:</strong> ${slip.patientInfo.name}</p>
                                    <p><strong>Mobile:</strong> ${slip.patientInfo.mobile}</p>
                                    <p><strong>Email:</strong> ${slip.patientInfo.email || 'Not provided'}</p>
                                    <p><strong>Age:</strong> ${slip.patientInfo.age}</p>
                                </div>
                                
                                <div>
                                    <h6 style="color: #007bff; margin-bottom: 10px;">üìÖ Appointment Details</h6>
                                    <p><strong>ID:</strong> ${slip.appointmentDetails.id}</p>
                                    <p><strong>Doctor:</strong> ${slip.appointmentDetails.doctor}</p>
                                    <p><strong>Date:</strong> ${slip.appointmentDetails.date}</p>
                                    <p><strong>Time:</strong> ${slip.appointmentDetails.time}</p>
                                    <p><strong>Status:</strong> <span style="color: ${getStatusColor(slip.appointmentDetails.status)}">${slip.appointmentDetails.status.toUpperCase()}</span></p>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-bottom: 15px;">
                                <h6 style="color: #007bff; margin-bottom: 10px;">ü©∫ Medical Information</h6>
                                <p><strong>Symptoms:</strong> ${slip.medicalInfo.symptoms}</p>
                                <p><strong>Diagnosis:</strong> ${slip.medicalInfo.diagnosis}</p>
                                <p><strong>Prescription:</strong> ${slip.medicalInfo.prescription}</p>
                                <p><strong>Follow-up:</strong> ${slip.medicalInfo.followUpDate}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                                <div>
                                    <h6 style="color: #007bff; margin-bottom: 10px;">‚è∞ Visit Information</h6>
                                    ${slip.visitInfo.checkinTime ? `<p><strong>Check-in:</strong> ${new Date(slip.visitInfo.checkinTime).toLocaleString('en-IN')}</p>` : ''}
                                    ${slip.visitInfo.completedTime ? `<p><strong>Completed:</strong> ${new Date(slip.visitInfo.completedTime).toLocaleString('en-IN')}</p>` : ''}
                                    <p><strong>Fee:</strong> ‚Çπ${slip.visitInfo.consultationFee} ${slip.visitInfo.currency}</p>
                                    <p><strong>Payment:</strong> <span style="color: ${slip.visitInfo.paymentStatus === 'Paid' ? '#28a745' : '#ffc107'}">${slip.visitInfo.paymentStatus}</span></p>
                                </div>
                                
                                <div>
                                    <h6 style="color: #007bff; margin-bottom: 10px;">üìã Slip Details</h6>
                                    <p><strong>Slip No:</strong> ${slip.slipNumber}</p>
                                    <p><strong>Generated:</strong> ${new Date(slip.generatedAt).toLocaleString('en-IN')}</p>
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                                        <strong>‚úÖ Official Medical Slip</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="printSlip()" style="flex: 1; padding: 12px; border: none; border-radius: 5px; background: #28a745; color: white; cursor: pointer;">
                                <i class="fas fa-print"></i> Print Slip
                            </button>
                            <button onclick="generateSlip()" style="flex: 0.5; padding: 12px; border: 1px solid #007bff; border-radius: 5px; background: white; color: #007bff; cursor: pointer;">
                                <i class="fas fa-receipt"></i> Generate Another
                            </button>
                        </div>
                    `);
                } else {
                    showPatientToolResult(`<p class="error">Failed to generate slip: ${data.error}</p>`);
                }
            } catch (error) {
                showPatientToolResult(`<p class="error">Slip generation failed: ${error.message}</p>`);
            }
        }

        function getStatusColor(status) {
            const colors = {
                'confirmed': '#007bff',
                'checked-in': '#28a745',
                'completed': '#6f42c1',
                'scheduled': '#ffc107',
                'cancelled': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }

        function printSlip() {
            window.print();
        }

        // === DOCTOR & CLINIC TOOLS ===

        async function optimizeCalendar() {
            try {
                const response = await fetch('/api/doctor/calendar/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doctorId: '1',
                        date: '2025-08-15'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const scheduleHtml = Object.entries(data.optimizedSchedule).map(([time, activity]) => `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                            <strong>${time}</strong> <span>${activity}</span>
                        </div>
                    `).join('');

                    showDoctorToolResult(`
                        <h5><i class="fas fa-calendar-alt"></i> AI Calendar Optimization</h5>
                        <p><strong>Doctor:</strong> ${data.doctor}</p>
                        <p><strong>Date:</strong> ${data.date}</p>
                        <div style="margin: 15px 0;">
                            <h6>Optimized Schedule:</h6>
                            ${scheduleHtml}
                        </div>
                        <div>
                            <h6>AI Improvements:</h6>
                            ${data.improvements.map(imp => `<p>‚Ä¢ ${imp}</p>`).join('')}
                        </div>
                    `);
                }
            } catch (error) {
                showDoctorToolResult(`<p class="error">Calendar optimization failed: ${error.message}</p>`);
            }
        }

        async function smartReschedule() {
            try {
                const response = await fetch('/api/doctor/reschedule-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doctorId: '1',
                        originalDate: '2025-08-10',
                        reason: 'Doctor emergency - surgery required'
                    })
                });

                const data = await response.json();
                showDoctorToolResult(`
                    <h5><i class="fas fa-exchange-alt"></i> Smart Rescheduling</h5>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Completed' : '‚ùå Failed'}</p>
                    <p><strong>Message:</strong> ${data.message}</p>
                    <p><strong>Reason:</strong> ${data.reason}</p>
                    ${data.rescheduledAppointments ? `
                        <div style="margin-top: 15px;">
                            <h6>Rescheduled Appointments:</h6>
                            ${data.rescheduledAppointments.map(apt => `
                                <p>‚Ä¢ ${apt.patient}: ${apt.originalTime} ‚Üí ${apt.newTime} with ${apt.newDoctor}</p>
                            `).join('')}
                        </div>
                    ` : ''}
                `);
            } catch (error) {
                showDoctorToolResult(`<p class="error">Smart rescheduling failed: ${error.message}</p>`);
            }
        }

        async function createTelemedicine() {
            try {
                // Get current appointments to find a valid ID
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                const appointmentId = appointmentsData.appointments && appointmentsData.appointments.length > 0 
                    ? appointmentsData.appointments[0].id 
                    : '1';
            
                const response = await fetch('/api/telemedicine/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId })
                });

                const data = await response.json();
                showDoctorToolResult(`
                    <h5><i class="fas fa-video"></i> Telemedicine Integration</h5>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Session Created' : '‚ùå Failed'}</p>
                    <p><strong>Message:</strong> ${data.message}</p>
                    <p><strong>Appointment ID:</strong> ${appointmentId}</p>
                    ${data.session ? `
                        <p><strong>Session ID:</strong> ${data.session.id}</p>
                        <p><strong>Patient:</strong> ${data.session.patient}</p>
                        <p><strong>Doctor:</strong> ${data.session.doctor}</p>
                        <p><strong>Scheduled:</strong> ${data.session.scheduledTime}</p>
                        <p><strong>Video Link:</strong> <a href="${data.session.videoLink}" target="_blank">${data.session.videoLink}</a></p>
                        <p><strong>Instructions:</strong> ${data.instructions}</p>
                    ` : ''}
                    ${!data.success ? `<p><strong>Error:</strong> ${data.error}</p>` : ''}
                `);
            } catch (error) {
                showDoctorToolResult(`<p class="error">Telemedicine setup failed: ${error.message}</p>`);
            }
        }

        async function viewAnalytics() {
            try {
                const response = await fetch('/api/analytics/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    const analytics = data.analytics;
                    showDoctorToolResult(`
                        <h5><i class="fas fa-chart-line"></i> Analytics Dashboard</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h6>Overview</h6>
                                <p>Total Appointments: ${analytics.overview.totalAppointments}</p>
                                <p>Completed: ${analytics.overview.completedAppointments}</p>
                                <p>Completion Rate: ${analytics.overview.completionRate}</p>
                                <p>No-Shows: ${analytics.overview.noShowAppointments}</p>
                            </div>
                            <div>
                                <h6>Trends</h6>
                                <p>Most Booked: ${analytics.trends.mostBookedSpecialty}</p>
                                <p>Peak Hours: ${analytics.trends.peakBookingHours.join(', ')}</p>
                                <p>Avg Wait: ${analytics.trends.averageWaitTime}</p>
                                <p>Satisfaction: ${analytics.trends.patientSatisfactionScore}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <h6>AI Predictions</h6>
                            <p>‚Ä¢ ${analytics.predictions.nextWeekBookings}</p>
                            <p>‚Ä¢ ${analytics.predictions.noShowRisk}</p>
                            <p>‚Ä¢ ${analytics.predictions.resourceNeeds}</p>
                        </div>
                        <p><strong>Generated:</strong> ${new Date(data.generatedAt).toLocaleString()}</p>
                    `);
                }
            } catch (error) {
                showDoctorToolResult(`<p class="error">Analytics loading failed: ${error.message}</p>`);
            }
        }

        function showPatientToolResult(html) {
            const resultsDiv = document.getElementById('patientToolsResults');
            const contentDiv = document.getElementById('toolsResultsContent');
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function showDoctorToolResult(html) {
            const resultsDiv = document.getElementById('doctorToolsResults');
            const contentDiv = document.getElementById('doctorResultsContent');
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // Real Razorpay Payment Integration
        async function payWithRazorpay() {
            try {
                // Get appointment ID
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                const appointmentId = appointmentsData.appointments && appointmentsData.appointments.length > 0 
                    ? appointmentsData.appointments[0].id 
                    : '1';
                
                // Create Razorpay order
                const orderResponse = await fetch('/api/payment/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        amount: 1500 // ‚Çπ1500 consultation fee
                    })
                });
                
                const orderData = await orderResponse.json();
                
                if (!orderData.success) {
                    throw new Error(orderData.error);
                }
                
                // Check if it's demo mode
                if (orderData.isDemo) {
                    // Show demo payment simulation
                    showPatientToolResult(`
                        <h5><i class="fas fa-info-circle" style="color: #17a2b8;"></i> Demo Payment Mode</h5>
                        <p><strong>üîß Demo Payment Simulation</strong></p>
                        <p><strong>Order ID:</strong> ${orderData.orderId}</p>
                        <p><strong>Amount:</strong> ‚Çπ${orderData.amount} INR</p>
                        <p><strong>Status:</strong> ‚úÖ Demo Payment Successful</p>
                        <p><strong>Appointment ID:</strong> ${orderData.appointmentId}</p>
                        <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>üìù Note:</strong> This is a demo simulation. ${orderData.message}
                        </div>
                        <div style="background: #d4edda; padding: 10px; border-radius: 5px;">
                            <strong>‚úÖ Demo consultation payment processed!</strong><br>
                            <small>In production, this would open the real Razorpay checkout.</small>
                        </div>
                    `);
                    return;
                }
                
                // Configure Razorpay checkout (for real payments)
                const options = {
                    key: orderData.key,
                    amount: orderData.amount * 100, // Amount in paise
                    currency: orderData.currency,
                    name: 'AI Healthcare Scheduler',
                    description: 'Doctor Consultation Fee',
                    image: 'https://cdn-icons-png.flaticon.com/512/3004/3004458.png',
                    order_id: orderData.orderId,
                    handler: async function (response) {
                        // Payment success - verify on backend
                        try {
                            const verifyResponse = await fetch('/api/payment/verify', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature,
                                    appointmentId: appointmentId
                                })
                            });
                            
                            const verifyData = await verifyResponse.json();
                            
                            if (verifyData.success) {
                                showPatientToolResult(`
                                    <h5><i class="fas fa-check-circle" style="color: #28a745;"></i> Payment Successful!</h5>
                                    <p><strong>üéâ Real payment completed via Razorpay!</strong></p>
                                    <p><strong>Payment ID:</strong> ${response.razorpay_payment_id}</p>
                                    <p><strong>Order ID:</strong> ${response.razorpay_order_id}</p>
                                    <p><strong>Amount:</strong> ‚Çπ${orderData.amount} INR</p>
                                    <p><strong>Gateway:</strong> Razorpay</p>
                                    <p><strong>Status:</strong> ‚úÖ Verified & Confirmed</p>
                                    <p><strong>Appointment ID:</strong> ${appointmentId}</p>
                                    <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                        <strong>‚úÖ Your consultation is now fully paid and confirmed!</strong>
                                    </div>
                                `);
                            } else {
                                throw new Error(verifyData.error);
                            }
                        } catch (verifyError) {
                            showPatientToolResult(`
                                <h5><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Payment Verification Failed</h5>
                                <p>Payment was made but verification failed: ${verifyError.message}</p>
                                <p>Please contact support with Payment ID: ${response.razorpay_payment_id}</p>
                            `);
                        }
                    },
                    prefill: {
                        name: 'Patient Name',
                        email: 'patient@example.com',
                        contact: '+91-9876543210'
                    },
                    notes: {
                        appointment_id: appointmentId,
                        service: 'Doctor Consultation'
                    },
                    theme: {
                        color: '#3395FF'
                    },
                    modal: {
                        ondismiss: function() {
                            showPatientToolResult(`
                                <h5><i class="fas fa-times-circle" style="color: #ffc107;"></i> Payment Cancelled</h5>
                                <p>Payment was cancelled by user.</p>
                                <p>You can try again when ready.</p>
                            `);
                        }
                    }
                };
                
                // Open Razorpay checkout
                const rzp = new Razorpay(options);
                rzp.open();
                
            } catch (error) {
                showPatientToolResult(`
                    <h5><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Payment Setup Failed</h5>
                    <p>Failed to initialize payment: ${error.message}</p>
                    <p>Please try again or use demo payment.</p>
                `);
            }
        }

        // === ADVANCED FEATURES ===

        let isLowBandwidth = false;

        // Low-Bandwidth Mode Toggle
        async function toggleLowBandwidth() {
            isLowBandwidth = !isLowBandwidth;
            const btn = document.getElementById('bandwidthBtn');
            
            try {
                const response = await fetch('/api/bandwidth/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'demo_user',
                        lowBandwidth: isLowBandwidth
                    })
                });

                const data = await response.json();
                btn.innerHTML = `<i class="fas fa-signal"></i> ${data.mode}`;
                btn.style.background = isLowBandwidth ? '#dc3545' : '#28a745';

                showPatientToolResult(`
                    <h5><i class="fas fa-signal"></i> Bandwidth Mode</h5>
                    <p><strong>Mode:</strong> ${data.mode}</p>
                    <p><strong>Status:</strong> ${data.message}</p>
                    <div style="margin-top: 15px;">
                        <h6>Features:</h6>
                        <p>‚Ä¢ Image Compression: ${data.features.imageCompression}</p>
                        <p>‚Ä¢ Animations: ${data.features.animations}</p>
                        <p>‚Ä¢ Data Usage: ${data.features.dataUsage}</p>
                        <p>‚Ä¢ Offline Mode: ${data.features.offlineMode}</p>
                    </div>
                    <div style="background: ${isLowBandwidth ? '#f8d7da' : '#d4edda'}; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>${isLowBandwidth ? 'üî¥ Low-bandwidth mode active' : 'üü¢ Normal mode active'}</strong>
                    </div>
                `);
            } catch (error) {
                console.error('Bandwidth toggle failed:', error);
            }
        }

        // Two-Factor Authentication
        async function show2FA() {
            try {
                const phoneNumber = '+91-9876543210'; // Demo number
                const response = await fetch('/api/auth/2fa/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'demo_user',
                        phoneNumber: phoneNumber
                    })
                });

                const data = await response.json();
                const otp = prompt(`2FA Setup: OTP sent to ${phoneNumber}\\n\\nFor demo, use OTP: ${data.testOTP}\\n\\nEnter OTP:`);
                
                if (otp) {
                    const verifyResponse = await fetch('/api/auth/2fa/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: 'demo_user',
                            otp: otp
                        })
                    });

                    const verifyData = await verifyResponse.json();
                    showPatientToolResult(`
                        <h5><i class="fas fa-shield-alt"></i> Two-Factor Authentication</h5>
                        <p><strong>Status:</strong> ${verifyData.success ? '‚úÖ Verified' : '‚ùå Failed'}</p>
                        <p><strong>Phone:</strong> ${phoneNumber}</p>
                        <p><strong>Message:</strong> ${verifyData.message}</p>
                        ${verifyData.success ? `
                            <p><strong>Security Level:</strong> ${verifyData.securityLevel}</p>
                            <p><strong>Token:</strong> ${verifyData.token}</p>
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>üîê Account secured with 2FA!</strong>
                            </div>
                        ` : `
                            <p><strong>Error:</strong> ${verifyData.error}</p>
                            ${verifyData.attemptsRemaining ? `<p><strong>Attempts Remaining:</strong> ${verifyData.attemptsRemaining}</p>` : ''}
                        `}
                    `);
                }
            } catch (error) {
                showPatientToolResult(`<p class="error">2FA setup failed: ${error.message}</p>`);
            }
        }

        // Encrypted Communication Demo
        async function showEncryption() {
            try {
                const message = "Your test results are ready. Please visit our clinic at your earliest convenience.";
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: 'Dr. Rajesh Sharma',
                        to: 'demo_user',
                        message: message,
                        encryption: true
                    })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5><i class="fas fa-lock"></i> Encrypted Communication</h5>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Message Sent Securely' : '‚ùå Failed'}</p>
                    <p><strong>Message ID:</strong> ${data.messageId}</p>
                    <p><strong>Encryption:</strong> ${data.encryption}</p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString('en-IN')}</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>üìß Original Message:</strong><br>
                        <em>"${message}"</em>
                    </div>
                    <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>üîê Message encrypted end-to-end with AES-256!</strong><br>
                        <small>Only you and your doctor can read this message.</small>
                    </div>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Encryption demo failed: ${error.message}</p>`);
            }
        }

        // Smart Home Integration
        async function testSmartHome() {
            try {
                const appointmentsResponse = await fetch('/api/appointments');
                const appointmentsData = await appointmentsResponse.json();
                
                const appointmentId = appointmentsData.appointments && appointmentsData.appointments.length > 0 
                    ? appointmentsData.appointments[0].id 
                    : '1';

                const devices = ['alexa', 'google', 'siri'];
                const selectedDevice = devices[Math.floor(Math.random() * devices.length)];

                const response = await fetch('/api/smarthome/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appointmentId: appointmentId,
                        device: selectedDevice,
                        action: 'appointment_reminder'
                    })
                });

                const data = await response.json();
                showPatientToolResult(`
                    <h5><i class="fas fa-home"></i> Smart Home Integration</h5>
                    <p><strong>Device:</strong> ${data.device.toUpperCase()}</p>
                    <p><strong>Status:</strong> ${data.success ? '‚úÖ Notification Sent' : '‚ùå Failed'}</p>
                    <p><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString('en-IN')}</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>üîä Voice Notification:</strong><br>
                        <em>"${data.notification}"</em>
                    </div>
                    <div style="margin-top: 15px;">
                        <h6>Available Actions:</h6>
                        ${data.actions.map(action => `
                            <p>‚Ä¢ ${action.action.replace('_', ' ').toUpperCase()}: ${action.available ? '‚úÖ Available' : '‚ùå Not Available'}</p>
                        `).join('')}
                    </div>
                    <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>üè† Smart home devices can now remind you about appointments!</strong>
                    </div>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Smart home test failed: ${error.message}</p>`);
            }
        }

        // Attendance Rewards System
        async function checkRewards() {
            try {
                const patientName = 'Rajesh Kumar'; // Demo patient
                const response = await fetch(`/api/rewards/${encodeURIComponent(patientName)}`);
                const data = await response.json();

                showPatientToolResult(`
                    <h5><i class="fas fa-gift"></i> Attendance Rewards</h5>
                    <p><strong>Patient:</strong> ${data.patient}</p>
                    <p><strong>Current Points:</strong> ${data.currentPoints} üèÜ</p>
                    <p><strong>Level:</strong> ${data.level} ${data.level === 'Gold' ? 'ü•á' : data.level === 'Silver' ? 'ü•à' : 'ü•â'}</p>
                    
                    <div style="margin: 15px 0;">
                        <h6>üìä Your Stats:</h6>
                        <p>‚Ä¢ Appointments Attended: ${data.stats.appointmentsAttended}</p>
                        <p>‚Ä¢ Appointments Missed: ${data.stats.appointmentsMissed}</p>
                        <p>‚Ä¢ Current Streak: ${data.stats.currentStreak}</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h6>üéÅ Available Rewards:</h6>
                        ${data.availableRewards.map(reward => `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: ${reward.available ? '#d4edda' : '#f8d7da'}; margin: 5px 0; border-radius: 5px;">
                                <span>${reward.name}</span>
                                <span>${reward.cost} points ${reward.available ? '‚úÖ' : '‚ùå'}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px;">
                        <strong>üéØ Next Goal:</strong> ${data.nextLevelRequirement}
                    </div>

                    <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <strong>üåü Keep attending appointments to earn more rewards!</strong><br>
                        <small>+100 points for each attended appointment, -50 for missed ones</small>
                    </div>
                `);
            } catch (error) {
                showPatientToolResult(`<p class="error">Rewards check failed: ${error.message}</p>`);
            }
        }
    </script>
</body>
</html>
